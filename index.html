<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ZERO SYSTEM | リスクアセスメント</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <?!= include('Stylesheet'); ?>
</head>
<body>
  <div class="container">
    <header class="main-header">
      <div class="header-left">
        <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
        <h1>ZERO SYSTEM</h1>
        <div class="header-info">
          <span class="id-badge">ID: <?= data.unique_id ?></span>
          <span class="status-badge status-<?= data.status.toLowerCase().replace(/\s+/g, '-') ?>"><?= data.status ?></span>
        </div>
      </div>
      <div class="header-right">
        <a href="<?= WEBAPP_BASE_URL ?>?id=<?= data.unique_id ?>&view=report" target="_blank" class="btn btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M5 2.5A2.5 2.5 0 0 0 2.5 5v10A2.5 2.5 0 0 0 5 17.5h10a2.5 2.5 0 0 0 2.5-2.5V8.31a.75.75 0 0 0-1.5 0V15a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h6.69a.75.75 0 0 0 0-1.5H5Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M8.25 2a.75.75 0 0 0 0 1.5h3.59L6.22 9.12a.75.75 0 0 0 1.06 1.06L13 4.56v3.59a.75.75 0 0 0 1.5 0V2a.75.75 0 0 0-.75-.75H8.25Z" clip-rule="evenodd" /></svg>
          <span>レポート出力</span>
        </a>
      </div>
    </header>

    <main class="main-content">
      <div class="timeline">
        <div class="timeline-item">
          <div class="timeline-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM9 9a.75.75 0 0 0 0 1.5h.253a.25.25 0 0 1 .244.304l-.459 2.066A1.75 1.75 0 0 0 10.747 15H11a.75.75 0 0 0 0-1.5h-.253a.25.25 0 0 1-.244-.304l.459-2.066A1.75 1.75 0 0 0 9.253 9H9Z" clip-rule="evenodd" /></svg></div>
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">基本情報</h2>
              <!-- ★修正: formatDate -> formatDateForHtml -->
              <span class="timestamp"><?= formatDateForHtml(data.timestamp) ?> 発見</span>
            </div>
            <div class="card-body">
              <div class="info-grid">
                <div class="info-label">件名</div><div class="info-value"><?= data.subject ?></div>
                <div class="info-label">発見者</div><div class="info-value"><?= data.discoverer_email ?></div>
                <div class="info-label">内容詳細</div><div class="info-value pre-wrap"><?= data.details ?></div>
              </div>
            </div>
          </div>
        </div>
        
        <? var isRiskEvalActive = data.status === 'リスク評価中'; ?>
        <div class="timeline-item">
          <div class="timeline-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M10.082 3.922c.395-.197.872-.197 1.267 0l6.432 3.216c.362.181.58.553.58.962v5.8c0 .41-.218.781-.58.962l-6.432 3.216c-.395.197-.872-.197-1.267 0L3.65 14.88c-.362-.181-.58-.553-.58-.962v-5.8c0-.41.218.781.58-.962l6.432-3.216ZM9.5 7.5a.5.5 0 0 0-1 0v5a.5.5 0 0 0 1 0v-5ZM11.5 9.5a.5.5 0 0 0-1 0v5a.5.5 0 0 0 1 0v-5Z" /></svg></div>
          <div class="card <?= isRiskEvalActive ? 'is-active' : '' ?>">
            <div class="card-header">
              <h2 class="card-title">AI一次評価 & 改善指示</h2>
            </div>
            <div class="card-body">
              <form id="form-secondary-eval">
                <input type="hidden" name="id" value="<?= data.unique_id ?>">
                <div class="ai-evaluation">
                  <h3>AIによる初期評価</h3>
                  <div class="info-grid">
                    <div class="info-label">評価理由</div><div class="info-value pre-wrap"><?= data.evaluation_reason ?></div>
                    <div class="info-label">改善プラン案</div><div class="info-value pre-wrap"><?= data.improvement_plan_ai ?></div>
                  </div>
                  <div class="score-correction">
                    <div class="score-correction-header">
                      <h4 class="score-correction-title">AI評価スコア</h4>
                      <? if (data.modified_by_evaluator_primary) { ?>
                        <span class="badge-modified">評価者による修正済み</span>
                      <? } ?>
                    </div>
                    <div class="score-form">
                      <div class="form-group-inline"><label class="form-label">頻度</label><select id="frequency_ai" name="frequency_ai" class="form-input" <?= !isRiskEvalActive ? 'disabled' : '' ?>><? var opts=[1,2,4]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.frequency_ai) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
                      <div class="form-group-inline"><label class="form-label">可能性</label><select id="likelihood_ai" name="likelihood_ai" class="form-input" <?= !isRiskEvalActive ? 'disabled' : '' ?>><? var opts=[1,2,4,6]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.likelihood_ai) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
                      <div class="form-group-inline"><label class="form-label">重篤度</label><select id="severity_ai" name="severity_ai" class="form-input" <?= !isRiskEvalActive ? 'disabled' : '' ?>><? var opts=[1,3,6,10]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.severity_ai) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">リスク評価コメント</label>
                  <textarea name="secondary_eval_comment" class="form-input" rows="4" required <?= !isRiskEvalActive ? 'disabled' : '' ?>><?= data.secondary_eval_comment || '' ?></textarea>
                </div>
                <div class="form-grid-4">
                    <div class="form-group"><label class="form-label">担当部署</label><select name="department" class="form-input" required <?= !isRiskEvalActive ? 'disabled' : '' ?>><option value="">選択</option><? for(var i=0; i < departments.length; i++) { ?><option value="<?= departments[i] ?>" <?= data.department == departments[i] ? 'selected' : '' ?>><?= departments[i] ?></option><? } ?></select></div>
                    <div class="form-group"><label class="form-label">担当者</label><input type="email" name="hopeful_evaluator" class="form-input" value="" required <?= !isRiskEvalActive ? 'disabled' : '' ?>></div>
                    <!-- ★修正: formatDate -> formatDateForHtml -->
                    <div class="form-group"><label class="form-label">期限</label><input type="date" name="deadline" class="form-input" value="<?= data.deadline ? formatDateForHtml(data.deadline, 'yyyy-MM-dd') : '' ?>" <?= !isRiskEvalActive ? 'disabled' : '' ?>></div>
                    <div class="form-group"><label class="form-label">暫定予算</label><input type="text" name="provisional_budget" class="form-input" value="<?= data.provisional_budget || '' ?>" <?= !isRiskEvalActive ? 'disabled' : '' ?>></div>
                </div>
                <div class="btn-group">
                  <button type="submit" class="btn btn-primary" <?= !isRiskEvalActive ? 'disabled' : '' ?>>改善指示を送信</button>
                </div>
                <div class="inline-msg"></div>
              </form>
            </div>
          </div>
        </div>

        <? var isImprovementActive = data.status === '改善報告中' || data.status === '差し戻し対応中'; ?>
        <? if (data.status !== 'リスク評価中') { ?>
        <div class="timeline-item">
          <div class="timeline-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M15.98 6.024a1.25 1.25 0 0 1 .521 2.05L10 15.549l-6.501-7.475a1.25 1.25 0 0 1 1.572-2.029L10 10.451l5.408-4.427a1.25 1.25 0 0 1 .572 0Z" /></svg></div>
          <div class="card <?= isImprovementActive ? 'is-active' : '' ?>">
            <div class="card-header"><h2 class="card-title">改善報告</h2></div>
            <div class="card-body">
              <? if (data.status === '差し戻し対応中' && data.revert_history && JSON.parse(data.revert_history).length > 0) { 
                  var lastRevert = JSON.parse(data.revert_history)[0];
              ?>
              <div class="revert-info-box">
                  <div class="revert-info-header">差し戻し情報</div>
                  <div class="info-grid">
                      <!-- ★修正: formatDate -> formatDateForHtml -->
                      <div class="info-label">日時</div><div class="info-value"><?= formatDateForHtml(lastRevert.timestamp) ?></div>
                      <div class="info-label">担当者</div><div class="info-value"><?= lastRevert.reverted_by ?></div>
                      <div class="info-label">理由</div><div class="info-value pre-wrap"><?= lastRevert.reason ?></div>
                  </div>
              </div>
              <? } ?>

              <form id="form-improvement-report">
                <input type="hidden" name="id" value="<?= data.unique_id ?>">
                <div class="form-group">
                    <label class="form-label">改善内容</label>
                    <textarea name="improvement_details" class="form-input" rows="5" required <?= !isImprovementActive ? 'disabled' : '' ?>><?= data.improvement_details || '' ?></textarea>
                </div>
                <div class="form-grid-3">
                    <div class="form-group"><label class="form-label">費用</label><input type="number" name="cost" class="form-input" value="<?= data.cost || '' ?>" <?= !isImprovementActive ? 'disabled' : '' ?>></div>
                    <div class="form-group"><label class="form-label">工数 (時間)</label><input type="number" step="0.1" name="effort" class="form-input" value="<?= data.effort || '' ?>" <?= !isImprovementActive ? 'disabled' : '' ?>></div>
                    <div class="form-group"><label class="form-label">効果(ROI)</label><input type="text" name="effect" class="form-input" value="<?= data.effect || '' ?>" <?= !isImprovementActive ? 'disabled' : '' ?>></div>
                </div>
                <div class="form-group">
                  <label class="form-label">チームメンバー</label>
                  <div class="form-grid-3">
                      <input type="email" name="team_member_1" class="form-input" placeholder="報告者(必須)" value="<?= data.reporter || '' ?>" required <?= !isImprovementActive ? 'disabled' : '' ?>>
                      <input type="email" name="team_member_2" class="form-input" placeholder="協力者1" value="<?= data.team_member_2 || '' ?>" <?= !isImprovementActive ? 'disabled' : '' ?>>
                      <input type="email" name="team_member_3" class="form-input" placeholder="協力者2" value="<?= data.team_member_3 || '' ?>" <?= !isImprovementActive ? 'disabled' : '' ?>>
                  </div>
                </div>
                 <div class="form-group">
                    <label class="form-label">参考URL</label>
                    <input type="url" name="reference_url" class="form-input" value="<?= data.reference_url || '' ?>" <?= !isImprovementActive ? 'disabled' : '' ?>>
                 </div>
                 <div class="form-group internal-card">
                  <label class="form-label">OJT関連</label>
                  <div class="form-grid-ojt">
                      <div class="form-group">
                           <label class="form-label">OJT登録</label>
                           <button type="button" class="btn-toggle" data-target="ojt_registered" <?= !isImprovementActive ? 'disabled' : '' ?>>
                             <input type="hidden" name="ojt_registered" id="ojt_registered" value="<?= data.ojt_registered ? 'true' : 'false' ?>">
                             <span class="text-on">OJT登録済</span><span class="text-off">OJT未登録</span>
                           </button>
                      </div>
                      <div class="form-group">
                          <label class="form-label">OJT実施</label>
                          <button type="button" class="btn-toggle" data-target="ojt_implemented" <?= !isImprovementActive ? 'disabled' : '' ?>>
                            <input type="hidden" name="ojt_implemented" id="ojt_implemented" value="<?= data.ojt_implemented ? 'true' : 'false' ?>">
                            <span class="text-on">OJT実施済</span><span class="text-off">OJT未実施</span>
                          </button>
                      </div>
                      <div class="form-group">
                          <label class="form-label">OJT ID</label>
                          <div class="input-with-button">
                             <input type="text" name="ojt_id" class="form-input" value="<?= data.ojt_id || '' ?>" <?= !isImprovementActive ? 'disabled' : '' ?>>
                            <a href="https://lookerstudio.google.com/s/qjaDkJXXraU" target="_blank" class="btn btn-secondary">ID確認</a>
                          </div>
                      </div>
                  </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary" <?= !isImprovementActive ? 'disabled' : '' ?>>改善内容を報告</button>
                </div>
                <div class="inline-msg"></div>
              </form>
            </div>
          </div>
        </div>
        <? } ?>

        <? var isFinalEvalActive = data.status === '最終評価中' || data.status === '再評価待ち'; ?>
<? if (data.status === '最終評価中' || data.status === '再評価待ち' || data.status === '完了') { ?>
<div class="timeline-item">
  <div class="timeline-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg></div>
  <div class="card <?= isFinalEvalActive ? 'is-active' : '' ?>">
    <div class="card-header"><h2 class="card-title">最終評価</h2></div>
    <div class="card-body">
      <form id="form-final-eval">
        <input type="hidden" name="id" value="<?= data.unique_id ?>">
        <? if(data.improvement_details) { ?>
        <div class="final-eval-section">
          <div class="section-header">
            <h3>提出された改善報告</h3>
            <? if (data.reference_url) { ?>
              <a href="<?= data.reference_url ?>" target="_blank" class="btn btn-secondary">参考URL</a>
            <? } ?>
          </div>
          <div class="info-grid">
            <div class="info-label">改善内容</div><div class="info-value pre-wrap"><?= data.improvement_details ?></div>
            <div class="info-label">費用</div><div class="info-value"><?= data.cost ? `¥${Number(data.cost).toLocaleString()}` : '-' ?></div>
            <div class="info-label">工数</div><div class="info-value"><?= data.effort ? `${data.effort} ` : '-' ?></div>
            <div class="info-label">効果</div><div class="info-value"><?= data.effect || '-' ?></div>
          </div>
        </div>
        <div class="final-eval-section">
          <h3>AIによる改善評価</h3>
          <div class="info-grid">
            <div class="info-label">AI講評</div><div class="info-value pre-wrap"><?= data.improvement_ai_comment ?></div>
          </div>
           <div class="score-correction">
              <div class="score-correction-header">
                <h4 class="score-correction-title">改善後スコア</h4>
                 <? if (data.modified_by_evaluator_final) { ?>
                   <span class="badge-modified">評価者による修正済み</span>
                 <? } ?>
              </div>
              <div class="score-form">
                <div class="form-group-inline"><label class="form-label">頻度</label><select id="post_frequency" name="post_frequency" class="form-input" <?= !isFinalEvalActive ? 'disabled' : '' ?>><? var opts=[1,2,4]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.post_frequency) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
                <div class="form-group-inline"><label class="form-label">可能性</label><select id="post_likelihood" name="post_likelihood" class="form-input" <?= !isFinalEvalActive ? 'disabled' : '' ?>><? var opts=[1,2,4,6]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.post_likelihood) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
                <div class="form-group-inline"><label class="form-label">重篤度</label><select id="post_severity" name="post_severity" class="form-input" <?= !isFinalEvalActive ? 'disabled' : '' ?>><? var opts=[1,3,6,10]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.post_severity) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
              </div>
            </div>
        </div>
        <? } ?>

          <div class="final-eval-section section-control-split">
            <h3>OJT実施状況確認</h3>
            <div class="control-group">
                <a href="https://script.google.com/a/macros/shabon.com/s/AKfycbz_4dkEmkyCndlrYdUUuqgzrioddSJ0givqmuh-LTviiD9wIV_jrgEIbqB5dycm6kem7A/exec" target="_blank" class="btn btn-secondary">OJT確認</a>
                <button type="button" class="btn-toggle" data-target="ojt_confirmed_final" <?= !isFinalEvalActive ? 'disabled' : '' ?>>
                  <input type="hidden" name="ojt_confirmed_final" id="ojt_confirmed_final" value="<?= data.ojt_confirmed_final ? 'true' : 'false' ?>">
                  <span class="text-on">OJT実施を確認済</span><span class="text-off">OJT実施は未確認</span>
                </button>
            </div>
          </div>

          <div class="final-eval-section section-control-split">
            <h3 class="knowledge-label"><strong>Good改善！</strong>みんなに共有する</h3>
            <button type="button" class="btn-toggle" data-target="good_practice" <?= !isFinalEvalActive ? 'disabled' : '' ?>>
              <input type="hidden" name="good_practice" id="good_practice" value="<?= data.good_practice ? 'true' : 'false' ?>">
              <span class="text-on">ナレッジ登録済</span><span class="text-off">ナレッジ未登録</span>
            </button>
          </div>

          <div class="form-group">
            <label class="form-label">最終評価コメント</label>
            <textarea name="final_eval_comment" class="form-input" rows="4" required <?= !isFinalEvalActive ? 'disabled' : '' ?>><?= data.final_eval_comment || '' ?></textarea>
          </div>
          <div class="btn-group">
            <button type="button" class="btn btn-danger revert-button" data-target-status="改善報告中" <?= !isFinalEvalActive ? 'disabled' : '' ?>>差し戻し</button>
            <button type="submit" class="btn btn-primary" <?= !isFinalEvalActive ? 'disabled' : '' ?>>評価を完了</button>
          </div>
          <div class="inline-msg"></div>
        </form>
    </div>
  </div>
</div>
<? } ?>
      </div>

      <aside class="sidebar">
        <div class="card">
          <div class="card-header"><h3 class="card-title">リスクサマリー</h3></div>
          <div class="card-body">
             <table class="score-table">
                <thead><tr><th>評価</th><th>頻度</th><th>可能性</th><th>重篤度</th><th>リスク</th><th>優先度</th></tr></thead>
                <tbody>
                  <tr><td>AI評価</td><td><?= data.frequency_ai ?></td><td><?= data.likelihood_ai ?></td><td><?= data.severity_ai ?></td><td class="score-value"><?= data.risk_score_ai ?></td><td><span class="priority-badge priority-<?= data.priority ?>"><?= data.priority ?></span></td></tr>
                  <tr><td>改善後</td><td><?= data.post_frequency || '-' ?></td><td><?= data.post_likelihood || '-' ?></td><td><?= data.post_severity || '-' ?></td><td class="score-value"><?= data.post_risk || '-' ?></td><td><span class="priority-badge priority-<?= data.post_priority ?>"><?= data.post_priority || '-' ?></span></td></tr>
                   <tr><td colspan="4"><strong>リスク低減値</strong></td><td colspan="2" class="score-value reduction-value"><?= data.risk_reduction_value === null ? '-' : data.risk_reduction_value ?></td></tr>
                </tbody>
              </table>
          </div>
        </div>
        <? if (data.revert_history && JSON.parse(data.revert_history).length > 0) { ?>
        <div class="card">
            <div class="card-header"><h3 class="card-title">差し戻し履歴</h3></div>
            <div class="card-body">
              <div class="revert-history-list">
                <? var history = JSON.parse(data.revert_history); ?>
                <? for(var i = 0; i < history.length; i++) { ?>
                  <div class="revert-item">
                    <!-- ★修正: formatDate -> formatDateForHtml -->
                    <div class="revert-meta"><?= formatDateForHtml(history[i].timestamp) ?> by <?= history[i].reverted_by ?></div>
                    <div class="revert-reason"><?= history[i].reason ?></div>
                  </div>
                <? } ?>
              </div>
            </div>
        </div>
        <? } ?>
      </aside>
    </main>

    <div id="revert-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="card-title">差し戻し理由</h2>
          <button id="cancel-revert" class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" /></svg></button>
        </div>
        <form id="revert-form">
          <input type="hidden" name="id" value="<?= data.unique_id ?>">
          <input type="hidden" name="targetStatus" value="">
          <div class="form-group">
            <label class="form-label">理由を具体的に入力してください。</label>
            <textarea name="reason" class="form-input" rows="4" required></textarea>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-danger">差し戻しを実行</button>
          </div>
          <div class="inline-msg"></div>
        </form>
      </div>
    </div>
  </div>
  <?!= include('JavaScript'); ?>
</body>
</html>
