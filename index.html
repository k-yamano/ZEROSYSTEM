<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>リスクアセスメント UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <?!= include('Stylesheet'); ?>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-main">
        <h1>リスクアセスメント</h1>
        <? if (data.unique_id) { ?>
        <div class="header-info">
          <div class="info-pill">ID: <strong><?= data.unique_id ?></strong></div>
          <div class="status-pill"><?= data.status ?></div>
        </div>
        <? } ?>
      </div>
      <button id="report-button" class="btn">📊 レポート出力</button>
    </header>

    <? if (!data.unique_id) { ?>
      <div class="card"><p>IDが指定されていないか、データが見つかりませんでした。</p></div>
    <? } else { ?>

    <div class="card">
       <h2 class="card-title">📋 基本情報</h2>
       <div class="info-grid">
         <span class="info-label">発見日時</span><span class="info-value"><?= formatDate(data.timestamp) ?></span>
         <span class="info-label">発見者</span><span class="info-value"><?= data.discoverer_email ?></span>
         <span class="info-label">件名</span><span class="info-value"><?= data.subject ?></span>
         <span class="info-label">内容</span><span class="info-value" style="white-space: pre-wrap;"><?= data.details ?></span>
       </div>
       <h3 class="card-title" style="margin-top: 2rem;">📊 スコアサマリー</h3>
      <table class="score-table">
        <thead>
          <tr><th>評価項目</th><th>頻度</th><th>可能性</th><th>重篤度</th><th>リスク値</th><th>優先度</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>AI評価</strong></td>
            <td class="tc"><?= data.frequency_ai ?></td><td class="tc"><?= data.likelihood_ai ?></td><td class="tc"><?= data.severity_ai ?></td>
            <td class="tc score-value"><?= data.risk_score_ai ?></td><td><span class="priority-badge <?= data.priority ?>"><?= data.priority ?></span></td>
          </tr>
          <tr>
            <td><strong>改善後評価</strong></td>
            <td class="tc"><?= data.post_frequency || '-' ?></td><td class="tc"><?= data.post_likelihood || '-' ?></td><td class="tc"><?= data.post_severity || '-' ?></td>
            <td class="tc score-value"><?= data.post_risk || '-' ?></td><td><span class="priority-badge <?= data.post_priority ?>"><?= data.post_priority || '-' ?></span></td>
          </tr>
          <tr>
            <td><strong>リスク低減値</strong></td>
            <td colspan="5" class="tc score-value" style="color: var(--success-gradient);"><?= data.risk_reduction_value === null ? '-' : data.risk_reduction_value ?></td>
          </tr>
        </tbody>
      </table>
    </div>

        <? if (data.status === 'リスク評価中' || data.status === '改善報告中') { ?>
      <? var isReadOnly = data.status === '改善報告中'; ?>
      <div id="card-risk-evaluation" class="card" <?= isReadOnly ? 'style="opacity:0.7;"' : '' ?>>
        <h2 class="card-title">🔍 リスク評価</h2>
        <div class="ai-card">
          <h3 class="ai-card-title">🤖 AIによる初期評価</h3>
          <div class="info-grid">
            <span class="info-label">事故の型分類</span><span class="info-value"><?= data.accident_type_ai ?></span>
            <span class="info-label">起因物</span><span class="info-value"><?= data.causal_agent_ai ?></span>
            <span class="info-label">評価理由</span><span class="info-value" style="white-space: pre-wrap;"><?= data.evaluation_reason ?></span>
            <span class="info-label">改善プラン案</span><span class="info-value" style="white-space: pre-wrap;"><?= data.improvement_plan_ai ?></span>
          </div>
        </div>
        <div class="score-correction">
          <h4>AI評価スコア修正
            <? if (data.modified_by_evaluator_primary) { ?>
              <span class="badge">修正済み</span>
            <? } ?>
          </h4>
          <form id="form-correct-ai" class="score-form">
              <input type="hidden" name="id" value="<?= data.unique_id ?>">
              <div class="form-group"><label>頻度</label><select name="frequency_ai" class="form-input" <?= isReadOnly ? 'disabled' : '' ?>><? var opts=[1,2,4]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.frequency_ai) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
              <div class="form-group"><label>可能性</label><select name="likelihood_ai" class="form-input" <?= isReadOnly ? 'disabled' : '' ?>><? var opts=[1,2,4,6]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.likelihood_ai) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
              <div class="form-group"><label>重篤度</label><select name="severity_ai" class="form-input" <?= isReadOnly ? 'disabled' : '' ?>><? var opts=[1,3,6,10]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.severity_ai) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
              <button type="submit" class="btn" <?= isReadOnly ? 'disabled' : '' ?>>修正</button>
          </form>
        </div>
        <form id="form-secondary-eval">
          <input type="hidden" name="id" value="<?= data.unique_id ?>">
          <div class="evaluator-grid">
            <div class="form-group">
              <label class="form-label">担当部署</label>
              <select name="department" class="form-input" required <?= isReadOnly ? 'disabled' : '' ?>>
                <option value="">選択</option>
                <? for(var i=0; i < departments.length; i++) { ?>
                  <option value="<?= departments[i] ?>" <?= data.department == departments[i] ? 'selected' : '' ?>><?= departments[i] ?></option>
                <? } ?>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">評価者</label>
              <input type="email" name="hopeful_evaluator" class="form-input" value="<?= data.hopeful_evaluator || '' ?>" required <?= isReadOnly ? 'disabled' : '' ?>>
            </div>
            <div class="form-group">
              <label class="form-label">期限</label>
              <input type="date" name="deadline" class="form-input" value="<?= data.deadline ? formatDate(data.deadline, 'yyyy-MM-dd') : '' ?>" <?= isReadOnly ? 'disabled' : '' ?>>
            </div>
            <div class="form-group">
              <label class="form-label">暫定予算</label>
              <input type="text" name="provisional_budget" class="form-input" value="<?= data.provisional_budget || '' ?>" <?= isReadOnly ? 'disabled' : '' ?>>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">評価者コメント</label>
            <textarea name="secondary_eval_comment" class="form-input" rows="4" required <?= isReadOnly ? 'disabled' : '' ?>><?= data.secondary_eval_comment || '' ?></textarea>
          </div>
          <div class="button-row">
            <button type="submit" class="btn" <?= isReadOnly ? 'disabled' : '' ?>>リスク評価を完了</button>
          </div>
          </form>
      </div>
    <? } ?>

    <? if (data.status === '改善報告中') { ?>
      <div id="card-improvement-report" class="card">
        <h2 class="card-title">🔧 改善報告</h2>
         <form id="form-improvement-report">
          <input type="hidden" name="id" value="<?= data.unique_id ?>">
          <div class="form-group"><label class="form-label">改善内容</label><textarea name="improvement_details" class="form-input" rows="4" required><?= data.improvement_details || '' ?></textarea></div>
          <div class="grid-3">
              <div class="form-group"><label class="form-label">費用</label><input type="number" name="cost" class="form-input" value="<?= data.cost || '' ?>"></div>
              <div class="form-group"><label class="form-label">工数 (人日)</label><input type="number" step="0.1" name="effort" class="form-input" value="<?= data.effort || '' ?>"></div>
              <div class="form-group"><label class="form-label">効果</label><input type="text" name="effect" class="form-input" value="<?= data.effect || '' ?>"></div>
          </div>
          <div class="form-group"><label class="form-label">チームメンバー</label><div class="grid-3"><input type="email" name="team_member_1" class="form-input" placeholder="報告者(必須)" value="<?= data.reporter || '' ?>" required><input type="email" name="team_member_2" class="form-input" placeholder="協力者1" value="<?= data.team_member_2 || '' ?>"><input type="email" name="team_member_3" class="form-input" placeholder="協力者2" value="<?= data.team_member_3 || '' ?>"></div></div>
          <div class="form-group"><label class="form-label">参考URL</label><input type="url" name="reference_url" class="form-input" value="<?= data.reference_url || '' ?>"></div>
          
          <div class="ojt-container">
            <label class="switch"><input type="checkbox" name="ojt_completed" value="true" required><span class="slider"></span></label>
            <label class="form-label" style="margin-bottom:0;">OJT登録 (必須)</label>
          </div>
          <div class="form-group">
              <label class="form-label">OJT ID (必須)</label>
              <div style="display:flex; gap: 1rem; align-items: center;">
                  <input type="text" name="ojt_id" class="form-input" value="<?= data.ojt_id || '' ?>" required>
                  <a href="https://lookerstudio.google.com/s/qjaDkJXXraU" target="_blank" class="btn btn-secondary" style="white-space:nowrap;">ID確認</a>
              </div>
          </div>

          <div class="button-row">
            <button type="button" class="btn btn-danger revert-button" data-target-status="リスク評価中">差し戻し</button>
            <button type="submit" class="btn">改善報告を送信</button>
          </div>
         </form>
      </div>
    <? } ?>

    <? if (data.status === '最終評価中') { ?>
      <div id="card-final-evaluation" class="card">
        <h2 class="card-title">✅ 最終評価</h2>
        <div class="score-correction">
          <h4>改善後スコア修正</h4>
          <form id="form-correct-post" class="score-form">
            <input type="hidden" name="id" value="<?= data.unique_id ?>">
            <div class="form-group"><label>頻度</label><select name="post_frequency" class="form-input"><? var opts=[1,2,4]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.post_frequency) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
            <div class="form-group"><label>可能性</label><select name="post_likelihood" class="form-input"><? var opts=[1,2,4,6]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.post_likelihood) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
            <div class="form-group"><label>重篤度</label><select name="post_severity" class="form-input"><? var opts=[1,3,6,10]; for(var i=0;i<opts.length;i++){ ?><option value="<?= opts[i] ?>" <?= Number(data.post_severity) === opts[i] ? 'selected' : '' ?>><?= opts[i] ?></option><? } ?></select></div>
            <button type="submit" class="btn">修正</button>
          </form>
        </div>
         <form id="form-final-eval">
          <input type="hidden" name="id" value="<?= data.unique_id ?>">
          <div class="form-group"><label class="form-label">最終評価コメント</label><textarea name="final_eval_comment" class="form-input" rows="4" required><?= data.final_eval_comment || '' ?></textarea></div>
          <div class="button-row">
            <button type="button" class="btn btn-danger revert-button" data-target-status="改善報告中">差し戻し</button>
            <button type="submit" class="btn">最終評価を完了</button>
          </div>
         </form>
      </div>
    <? } ?>

    <div id="revert-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <h2>差し戻し理由</h2>
        <form id="revert-form">
          <input type="hidden" name="id" value="<?= data.unique_id ?>">
          <input type="hidden" name="targetStatus" value="">
          <div class="form-group"><label class="form-label">理由を具体的に入力してください。</label><textarea name="reason" class="form-input" rows="4" required></textarea></div>
          <div class="button-row">
            <button type="button" id="cancel-revert" class="btn btn-secondary">キャンセル</button>
            <button type="submit" class="btn btn-danger">差し戻しを実行</button>
          </div>
        </form>
      </div>
    </div>
    
    <? } /* end if data.unique_id */ ?>
  </div>
  <?!= include('JavaScript'); ?>
</body>
</html>