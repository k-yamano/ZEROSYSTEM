<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>リスクアセスメントレポート - <?= data.unique_id ?></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --font-sans: 'Helvetica Neue', 'Arial', 'Hiragino Sans', 'Meiryo', sans-serif;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --border-color: #d1d5db;
      --surface-color: #f9fafb;
    }
    body { font-family: var(--font-sans); color: var(--text-primary); background-color: #f3f4f6; line-height: 1.6; }
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f3f4f6;
    }
    .page { 
        width: 210mm; 
        min-height: 297mm; 
        padding: 20mm; 
        margin: 20mm 0; /* ★修正: 上下のマージンを調整 */
        background: white; 
        box-shadow: 0 0 10px rgba(0,0,0,0.1); 
    }
    .info-grid div {
        word-break: break-word; /* ★追加: 長い文字列がはみ出ないようにする */
    }
    /* (後略) */
    @media print {
      html, body {
        display: block; /* ★追加: 印刷時はflex解除 */
        height: auto;
        background-color: #fff;
      }
      .page { margin: 0; box-shadow: none; border: none; width: 100%; min-height: initial; }
      .no-print { display: none; }
    }
    .page { width: 210mm; min-height: 297mm; padding: 20mm; margin: 10mm auto; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .report-header { text-align: center; border-bottom: 2px solid var(--text-primary); padding-bottom: 1rem; margin-bottom: 2rem; }
    .report-title { font-size: 2rem; font-weight: bold; margin: 0; }
    .report-id { font-size: 1rem; color: var(--text-secondary); }
    .section { margin-bottom: 2rem; page-break-inside: avoid; }
    .section-title { font-size: 1.25rem; font-weight: bold; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
    .info-grid { display: grid; grid-template-columns: 150px 1fr; gap: 0.75rem; }
    .info-label { font-weight: bold; color: var(--text-secondary); }
    .pre-wrap { white-space: pre-wrap; font-family: var(--font-sans); }
    .score-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .score-table th, .score-table td { border: 1px solid var(--border-color); padding: 0.75rem; text-align: center; }
    .score-table th { background-color: var(--surface-color); font-weight: bold; }
    .priority-badge { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 12px; font-weight: 600; }
    .priority-高 { background-color: #fee2e2; color: #b91c1c; }
    .priority-中 { background-color: #ffedd5; color: #9a3412; }
    .priority-低 { background-color: #d1fae5; color: #065f46; }
    .report-footer { text-align: center; margin-top: 3rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.875rem; color: var(--text-secondary); }
    
    /* ★追加: 印刷ボタン用のスタイル */
    .print-button-container { text-align: center; margin-bottom: 20px; }
    .print-button {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 20px; font-size: 16px; color: white;
      background-color: #4f46e5; border: none; border-radius: 8px;
      cursor: pointer;
    }
    .print-button:hover { background-color: #3730a3; }

    @media print {
      body { margin: 0; background-color: #fff; }
      .page { margin: 0; box-shadow: none; border: none; width: 100%; min-height: initial; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  
  <div class="no-print print-button-container">
    <button class="print-button" onclick="window.print()">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M5 2.5A2.5 2.5 0 0 0 2.5 5v1.25a.75.75 0 0 0 1.5 0V5a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1.25a.75.75 0 0 0 1.5 0V5A2.5 2.5 0 0 0 15 2.5H5Z" clip-rule="evenodd" /><path d="M2.5 8.5A.5.5 0 0 1 3 8h14a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5v-5Z" /><path fill-rule="evenodd" d="M5 15.5A2.5 2.5 0 0 0 2.5 13V9h15v4a2.5 2.5 0 0 1-2.5 2.5H5Zm1-2.5a.5.5 0 0 0 0 1h8a.5.5 0 0 0 0-1H6Z" clip-rule="evenodd" /></svg>
      <span>このレポートを印刷</span>
    </button>
  </div>

  <div class="page">
    <header class="report-header">
      <h1 class="report-title">リスクアセスメントレポート</h1>
      <p class="report-id">ID: <?= data.unique_id ?></p>
    </header>

    <main>
      <section class="section">
        <h2 class="section-title">1. 基本情報</h2>
        <div class="info-grid">
          <div class="info-label">件名</div><div><?= data.subject ?></div>
          <div class="info-label">発見日時</div><div><?= formatDate(data.timestamp) ?></div>
          <div class="info-label">発見者</div><div><?= data.discoverer_email ?></div>
          <div class="info-label">内容詳細</div><div class="pre-wrap"><?= data.details ?></div>
          <div class="info-label">リスク評価者</div><div><?= data.hopeful_evaluator ?></div>
        </div>
      </section>

      <section class="section">
        <h2 class="section-title">2. リスク評価サマリー</h2>
        <table class="score-table">
          <thead><tr><th>評価項目</th><th>頻度</th><th>可能性</th><th>重篤度</th><th>リスク値</th><th>優先度</th></tr></thead>
          <tbody>
            <tr><td><strong>AI評価</strong></td><td><?= data.frequency_ai ?></td><td><?= data.likelihood_ai ?></td><td><?= data.severity_ai ?></td><td><?= data.risk_score_ai ?></td><td><span class="priority-badge priority-<?= data.priority ?>"><?= data.priority ?></span></td></tr>
            <tr><td><strong>改善後評価</strong></td><td><?= data.post_frequency || '-' ?></td><td><?= data.post_likelihood || '-' ?></td><td><?= data.post_severity || '-' ?></td><td><?= data.post_risk || '-' ?></td><td><span class="priority-badge priority-<?= data.post_priority ?>"><?= data.post_priority || '-' ?></span></td></tr>
            <tr><td colspan="4"><strong>リスク低減値</strong></td><td colspan="2"><?= data.risk_reduction_value === null ? '-' : data.risk_reduction_value ?></td></tr>
          </tbody>
        </table>
      </section>
      
      <section class="section">
        <h2 class="section-title">3. 改善報告詳細</h2>
        <div class="info-grid">
            <div class="info-label">改善報告者</div><div><?= data.reporter ?></div>
            <div class="info-label">協力者</div><div><?= [data.team_member_2, data.team_member_3].filter(Boolean).join(', ') || '-' ?></div>
            <div class="info-label">費用</div><div><?= data.cost ? `¥${Number(data.cost).toLocaleString()}` : '-' ?></div>
            <div class="info-label">工数</div><div><?= data.effort ? `${data.effort} 人日` : '-' ?></div>
            <div class="info-label">効果</div><div><?= data.effect ?></div>
            <div class="info-label">参考URL</div><div><?= data.reference_url ? `<a href="${data.reference_url}" target="_blank">${data.reference_url}</a>` : '-' ?></div>
        </div>
      </section>

      <section class="section">
        <h2 class="section-title">4. 評価と改善の経緯</h2>
        <div class="info-grid">
          <div class="info-label">AI評価理由</div><div class="pre-wrap"><?= data.evaluation_reason ?></div>
          <div class="info-label">管理者コメント</div><div class="pre-wrap"><?= data.secondary_eval_comment ?></div>
          <div class="info-label">改善報告</div><div class="pre-wrap"><?= data.improvement_details ?></div>
          <div class="info-label">AI改善評価</div><div class="pre-wrap"><?= data.improvement_ai_comment ?></div>
          <div class="info-label">最終評価コメント</div><div class="pre-wrap"><?= data.final_eval_comment ?></div>
        </div>
      </section>
    </main>

    <footer class="report-footer">
      ZEROSYSTEM | 出力日時: <?= formatDate(new Date()) ?>
    </footer>
  </div>
   <script>
    // ユーティリティ関数（GAS側と重複するが、レポート単体でも機能するように）
    function formatDate(dateString, format = 'yyyy/MM/dd HH:mm') {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        return date.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
      } catch(e) {
        return dateString;
      }
    }
   </script>
</body>
</html>