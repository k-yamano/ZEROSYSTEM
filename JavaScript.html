<script>
document.addEventListener('DOMContentLoaded', function() {
    const status = "<?= data.status ?>";
    setupForms();
    setupModal();
    updateUI(status);
});

function setupForms() {
    listen('form-correct-ai', 'updateScores');
    listen('form-secondary-eval', 'submitEval');
    listen('form-improvement-report', 'submitImprovement');
    listen('form-correct-post', 'updateScores');
    listen('form-final-eval', 'submitFinal');
    listen('revert-form', 'revert');
    
    const reportBtn = document.getElementById('report-button');
    if (reportBtn) {
        reportBtn.addEventListener('click', () => {
            const reportUrl = "<?= WEBAPP_BASE_URL ?>?id=<?= data.unique_id ?>&view=report";
            window.open(reportUrl, '_blank');
        });
    }
}

function listen(formId, action) {
    const form = document.getElementById(formId);
    if (!form) return;
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        setBusy(form, true);
        showMsg(form, '送信中...', 'info');
        google.script.run
            .withSuccessHandler(res => {
                showMsg(form, res, 'success');
                if (form.id !== 'revert-form') {
                    setTimeout(() => location.reload(), 1500);
                } else {
                    document.getElementById('revert-modal').style.display = 'none';
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .withFailureHandler(err => {
                setBusy(form, false);
                showMsg(form, err.message, 'error');
            })
            .serverAction(action, data);
    });
}

function setBusy(form, isBusy) {
    form.querySelectorAll('input, select, textarea, button').forEach(el => el.disabled = isBusy);
    form.style.opacity = isBusy ? 0.7 : 1;
}

function showMsg(form, message, type) {
    let msgBox = form.querySelector('.inline-msg');
    if (!msgBox) {
        msgBox = document.createElement('div');
        form.prepend(msgBox);
    }
    msgBox.className = `inline-msg ${type}`;
    msgBox.textContent = message;
}

function setupModal() {
    const modal = document.getElementById('revert-modal');
    if (!modal) return;
    document.querySelectorAll('.revert-button').forEach(btn => {
        btn.addEventListener('click', function() {
            modal.querySelector('[name="targetStatus"]').value = this.dataset.targetStatus;
            modal.style.display = 'block';
        });
    });
    document.getElementById('cancel-revert')?.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });
}

/** ★★★ UIの編集可否を制御する関数 (修正版) ★★★ */
function updateUI(status) {
    const allCards = document.querySelectorAll('.card[id]');
    allCards.forEach(card => {
        card.classList.add('disabled');
        card.querySelectorAll('input, select, textarea, button').forEach(el => el.disabled = true);
    });

    const activeCardIdMap = {
        'リスク評価中': 'card-risk-evaluation',
        '改善報告中': 'card-improvement-report',
        '最終評価中': 'card-final-evaluation',
    };

    const activeCardId = activeCardIdMap[status];
    if (activeCardId) {
        const activeCard = document.getElementById(activeCardId);
        if (activeCard) {
            activeCard.classList.remove('disabled');
            activeCard.querySelectorAll('input, select, textarea, button').forEach(el => el.disabled = false);
        }
    }
}
</script>