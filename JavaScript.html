<script>
document.addEventListener('DOMContentLoaded', function() {
    const status = "<?= data.status ?>";
    const uniqueId = "<?= data.unique_id ?>";

    // Event Listeners
    setupFormSubmission('form-correct-secondary', 'updateSecondaryScores');
    setupFormSubmission('form-secondary-eval', 'submitSecondaryEvaluation');
    setupFormSubmission('form-improvement-report', 'submitImprovementReport');
    setupFormSubmission('form-correct-post', 'updatePostImproveScores');
    setupFormSubmission('form-final-eval', 'submitFinalEvaluation');
    setupFormSubmission('revert-form', 'revertStatus');
    
    const reportBtn = document.getElementById('report-button');
    if (reportBtn) {
        reportBtn.addEventListener('click', () => {
            if (reportBtn.disabled) return;
            const reportUrl = "<?= buildIncidentReportUrl(uniqueId) ?>";
            window.open(reportUrl, '_blank');
        });
    }

    setupModal();
    updateWorkflowUI(status);
});

function setFormBusyState(form, isBusy) {
    const elements = form.querySelectorAll('input, select, textarea, button');
    elements.forEach(el => el.disabled = isBusy);
    form.style.opacity = isBusy ? 0.7 : 1;
}

function showInlineMessage(form, message, type) {
    let msgBox = form.querySelector('.inline-msg');
    const buttonRow = form.querySelector('.button-row');
    if (!msgBox) {
        msgBox = document.createElement('div');
        msgBox.className = 'inline-msg';
        if(buttonRow) {
            form.insertBefore(msgBox, buttonRow);
        } else {
            form.appendChild(msgBox);
        }
    }
    msgBox.textContent = message;
    msgBox.className = `inline-msg ${type}`;
}

function setupFormSubmission(formId, functionName) {
    const form = document.getElementById(formId);
    if (!form) return;

    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        
        setFormBusyState(form, true);
        showInlineMessage(form, '送信中...', 'info');

        google.script.run
            .withSuccessHandler(response => {
                setFormBusyState(form, false);
                showInlineMessage(form, response, 'success');
            })
            .withFailureHandler(error => {
                setFormBusyState(form, false);
                showInlineMessage(form, error.message, 'error');
            })
            [functionName](data);
    });
}

function setupModal() {
    const modal = document.getElementById('revert-modal');
    if (!modal) return;
    const revertButtons = document.querySelectorAll('.revert-button');
    const cancelBtn = document.getElementById('cancel-revert');
    const revertForm = document.getElementById('revert-form');

    revertButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const targetStatus = this.dataset.targetStatus;
            revertForm.querySelector('[name="targetStatus"]').value = targetStatus;
            modal.style.display = 'block';
        });
    });

    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => modal.style.display = 'none');
    }
    
    window.addEventListener('click', event => {
        if (event.target === modal) modal.style.display = 'none';
    });
}

function updateWorkflowUI(status) {
    const riskEvalCard = document.getElementById('card-risk-evaluation');
    const improvementCard = document.getElementById('card-improvement-report');
    const finalEvalCard = document.getElementById('card-final-evaluation');
    const reportButton = document.getElementById('report-button');

    [riskEvalCard, improvementCard, finalEvalCard].forEach(c => {
        if (c) c.classList.add('disabled');
    });

    if (status === 'リスク評価中') {
        if (riskEvalCard) riskEvalCard.classList.remove('disabled');
    } else if (status === '改善報告中') {
        if (improvementCard) improvementCard.classList.remove('disabled');
    } else if (status === '最終評価中') {
        if (improvementCard) improvementCard.classList.remove('disabled');
        if (finalEvalCard) finalEvalCard.classList.remove('disabled');
    }

    if (reportButton) {
        reportButton.disabled = (status !== '完了');
    }
}
</script>

