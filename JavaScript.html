<script>
  document.addEventListener('DOMContentLoaded', function() {
  // ★修正: form-secondary-eval から noReload: true を削除
  handleFormSubmit('form-secondary-eval', 'submitSecondaryEvaluation');
  handleFormSubmit('form-improvement-report', 'submitImprovementReport', { noReload: true });
  handleFormSubmit('form-correct-ai', 'updateScores', { noReload: true });
  handleFormSubmit('form-correct-post', 'updatePostImproveScores', { noReload: true });
  handleFormSubmit('form-final-eval', 'submitFinalEvaluation');
  handleFormSubmit('revert-form', 'revert', { 
      noReload: true, 
      onSuccess: () => {
          const modal = document.getElementById('revert-modal');
          if(modal) modal.style.display = 'none';
          setTimeout(() => { location.reload(); }, 1000); // 差し戻し後もリロード
      }
            // ★追加: 成功時にモーダルを閉じる
            const modal = document.getElementById('revert-modal');
            if(modal) modal.style.display = 'none';
        }
    });

    // モーダル表示の紐付け
    document.querySelectorAll('.revert-button').forEach(btn => {
      btn.addEventListener('click', function() {
        const modal = document.getElementById('revert-modal');
        if (modal) {
          modal.querySelector('[name="targetStatus"]').value = this.dataset.targetStatus;
          modal.style.display = 'flex';
        }
      });
    });
    document.getElementById('cancel-revert')?.addEventListener('click', () => {
      document.getElementById('revert-modal').style.display = 'none';
    });
  });

  // フォーム送信処理を共通化
  function handleFormSubmit(formId, serverActionName, options = {}) {
    const form = document.getElementById(formId);
    if (!form) return;
    
    if (form.submitHandler) form.removeEventListener('submit', form.submitHandler);

    form.submitHandler = function(e) {
      e.preventDefault();
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const data = Object.fromEntries(new FormData(form).entries());
      setBusy(form, true);
      showMsg(form, '送信中...', 'info');

      google.script.run
        .withSuccessHandler(function(msg) {
          setBusy(form, false);
          showMsg(form, msg, 'success');
          
          // ★追加: 成功時のコールバックを実行
          if (options.onSuccess) {
              options.onSuccess();
          }

          // オプションでリロードを制御
          if (!options.noReload) {
            setTimeout(() => { location.reload(); }, 1500);
          } else {
            // ★追加: 3秒後にメッセージを消す
            setTimeout(() => { showMsg(form, '', 'info'); }, 3000);
          }
        })
        .withFailureHandler(function(err) {
          setBusy(form, false);
          showMsg(form, err.message, 'error');
        })
        .serverAction(serverActionName, data);
    };
    
    form.addEventListener('submit', form.submitHandler);
  }

  function setBusy(form, isBusy) {
    if (!form) return;
    form.querySelectorAll('input, select, textarea, button').forEach(el => {
       el.disabled = !!isBusy;
    });
    form.style.opacity = isBusy ? 0.7 : 1;
  }

  function showMsg(form, message, type) {
    let msgBox = form.querySelector('.inline-msg');
    if (msgBox) {
        msgBox.textContent = message;
        msgBox.className = `inline-msg ${type}`;
    }
  }

  function formatDate(dateString, format = 'yyyy/MM/dd HH:mm') {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      
      if (format === 'yyyy-MM-dd') {
        return date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
      }
      
      return date.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\//g, '/');
    } catch(e) {
      return dateString;
    }
  }
</script>