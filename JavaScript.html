<script>
  // グローバルスコープで初期スコアを保存するオブジェクトを定義
  const initialScores = {};

  document.addEventListener('DOMContentLoaded', function() {
    
    // --- ページ読み込み時に初期スコアを保存 ---
    const primaryScoreIds = ['frequency_ai', 'likelihood_ai', 'severity_ai'];
    const finalScoreIds = ['post_frequency', 'post_likelihood', 'post_severity'];

    primaryScoreIds.forEach(id => {
      const element = document.getElementById(id);
      if (element) initialScores[id] = element.value;
    });
    finalScoreIds.forEach(id => {
      const element = document.getElementById(id);
      if (element) initialScores[id] = element.value;
    });

    // --- フォーム送信処理 ---
    handleFormSubmit('form-secondary-eval', 'submitSecondaryEvaluation', { noReload: true });
    handleFormSubmit('form-improvement-report', 'submitImprovementReport', { noReload: true });
    handleFormSubmit('form-final-eval', 'submitFinalEvaluation', { noReload: true });
    
    handleFormSubmit('revert-form', 'revert', { 
        noReload: true, 
        onSuccess: () => {
            const modal = document.getElementById('revert-modal');
            if(modal) modal.style.display = 'none';
            showMsg(document.getElementById('revert-form'), "差し戻しました。ページを更新します。", "success");
            setTimeout(() => { location.reload(); }, 1500);
        }
    });

    // モーダル表示の紐付け
    document.querySelectorAll('.revert-button').forEach(btn => {
      btn.addEventListener('click', function() {
        const modal = document.getElementById('revert-modal');
        if (modal) {
          modal.querySelector('[name="targetStatus"]').value = this.dataset.targetStatus;
          modal.style.display = 'flex';
        }
      });
    });
    document.getElementById('cancel-revert')?.addEventListener('click', () => {
      document.getElementById('revert-modal').style.display = 'none';
    });

    // テキスト付きトグルボタンの処理
    document.querySelectorAll('.btn-toggle').forEach(btn => {
      const targetInput = document.getElementById(btn.dataset.target);
      if (targetInput && targetInput.value === 'true') {
        btn.classList.add('is-active');
      }
      btn.addEventListener('click', function() {
        if (targetInput) {
          const isActive = this.classList.toggle('is-active');
          targetInput.value = isActive ? 'true' : 'false';
        }
      });
    });
  });

  // フォーム送信の共通処理
  function handleFormSubmit(formId, serverActionName, options = {}) {
    const form = document.getElementById(formId);
    if (!form) return;
    
    if (form.submitHandler) form.removeEventListener('submit', form.submitHandler);

    form.submitHandler = function(e) {
      e.preventDefault();
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // ★修正: 送信時にスコアの変更を確認する
      let isModified = false;
      if (formId === 'form-secondary-eval') {
        isModified = ['frequency_ai', 'likelihood_ai', 'severity_ai'].some(id => document.getElementById(id).value !== initialScores[id]);
      } else if (formId === 'form-final-eval') {
        isModified = ['post_frequency', 'post_likelihood', 'post_severity'].some(id => document.getElementById(id) && document.getElementById(id).value !== initialScores[id]);
      }

      if (isModified) {
        if (!confirm('スコアが修正されています。この内容で送信しますか？')) {
          return; // ユーザーがキャンセルしたら送信を中止
        }
      }
      
      const data = Object.fromEntries(new FormData(form).entries());
      setFormDisabled(form, true);
      showMsg(form, '送信中...', 'info');

      google.script.run
        .withSuccessHandler(function(msg) {
          showMsg(form, msg, 'success');
          setFormDisabled(form, true); // 成功したらフォームは無効のまま
          
          // ステータス表示を更新
           if (formId === 'form-secondary-eval') updateStatusUI('改善報告中', 'status-改善報告中');
           if (formId === 'form-improvement-report') updateStatusUI('最終評価中', 'status-最終評価中');
           if (formId === 'form-final-eval') updateStatusUI('完了', 'status-完了');

          if (!options.noReload) {
            setTimeout(() => { location.reload(); }, 1500);
          } else {
            setTimeout(() => { showMsg(form, '', 'info'); }, 5000);
          }
        })
        .withFailureHandler(function(err) {
          setFormDisabled(form, false); // 失敗したら再操作可能にする
          showMsg(form, err.message, 'error');
        })
        [serverActionName](data);
    };
    
    form.addEventListener('submit', form.submitHandler);
  }

  // --- ヘルパー関数 ---
  function setFormDisabled(form, isDisabled) {
    if (!form) return;
    form.querySelectorAll('input, select, textarea, button').forEach(el => {
       el.disabled = !!isDisabled;
    });
    form.style.opacity = isDisabled ? 0.7 : 1;
  }
  
  function updateStatusUI(newStatus, newClass) {
      const badge = document.querySelector('.status-badge');
      if(badge) {
          badge.textContent = newStatus;
          badge.className = `status-badge ${newClass}`;
      }
  }

  function showMsg(form, message, type) {
    let msgBox = form.querySelector('.inline-msg');
    if (msgBox) {
        msgBox.textContent = message;
        msgBox.className = `inline-msg ${type}`;
    }
  }

  function formatDate(dateString, format = 'yyyy/MM/dd HH:mm') {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      
      if (format === 'yyyy-MM-dd') {
        return date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
      }
      
      return date.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\//g, '/');
    } catch(e) {
      return dateString;
    }
  }
</script>