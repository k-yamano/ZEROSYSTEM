<script>
  document.addEventListener('DOMContentLoaded', function() {
    handleFormSubmit('form-secondary-eval', 'submitSecondaryEvaluation');
    handleFormSubmit('form-improvement-report', 'submitImprovementReport');
    handleFormSubmit('form-correct-post', 'updatePostImproveScores');
    handleFormSubmit('form-final-eval', 'submitFinalEvaluation');
    handleFormSubmit('revert-form', 'revert');

    // AIスコア修正フォームは、メインフォームとは別にデータを送信
    const correctAiForm = document.getElementById('form-correct-ai');
    if(correctAiForm) {
      correctAiForm.addEventListener('submit', function(e){
        e.preventDefault();
        handleFormSubmit('form-correct-ai', 'updateScores');
      });
    }

    document.querySelectorAll('.revert-button').forEach(btn => {
      btn.addEventListener('click', function() {
        const modal = document.getElementById('revert-modal');
        modal.querySelector('[name="targetStatus"]').value = this.dataset.targetStatus;
        modal.style.display = 'block';
      });
    });
    document.getElementById('cancel-revert')?.addEventListener('click', () => {
      document.getElementById('revert-modal').style.display = 'none';
    });
  });

  // AIスコア修正フォームのデータをメインフォームにコピーしてから送信するヘルパー
  function handleCorrectAiSubmit() {
    const mainForm = document.getElementById('form-secondary-eval');
    const scoreForm = document.getElementById('form-correct-ai');
    
    // score-formのデータをmain-formにコピー
    mainForm.frequency_ai.value = scoreForm.frequency_ai.value;
    mainForm.likelihood_ai.value = scoreForm.likelihood_ai.value;
    mainForm.severity_ai.value = scoreForm.severity_ai.value;

    // 隠しフォームを送信
    handleFormSubmit('form-correct-ai', 'updateScores');
  }

  function handleFormSubmit(formId, serverActionName) {
    const form = document.getElementById(formId);
    if (!form) return;
    
    const submitHandler = function(e) {
      e.preventDefault();
      
      const ojtCheckbox = form.querySelector('input[name="ojt_completed"]');
      if (ojtCheckbox && ojtCheckbox.required && !ojtCheckbox.checked) {
        showMsg(form, 'OJT登録のチェックは必須です。', 'error');
        return;
      }
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const data = Object.fromEntries(new FormData(form).entries());
      setBusy(form, true);
      showMsg(form, '送信中...', 'info');

      google.script.run
        .withSuccessHandler(function(msg) {
          setBusy(form, false);
          showMsg(form, msg, 'success');
          if (serverActionName === 'revert') {
             document.getElementById('revert-modal').style.display = 'none';
          }
        })
        .withFailureHandler(function(err) {
          setBusy(form, false);
          showMsg(form, err.message, 'error');
        })
        [serverActionName](data);
    };

    // 既存のイベントリスナーを削除してから追加
    form.removeEventListener('submit', form.submitHandler);
    form.submitHandler = submitHandler;
    form.addEventListener('submit', form.submitHandler);
  }

  function setBusy(form, isBusy) {
    if (!form) return;
    form.querySelectorAll('input, select, textarea, button').forEach(el => {
      if(el.type !== 'button' || !el.classList.contains('revert-button')) {
         el.disabled = !!isBusy;
      }
    });
    form.style.opacity = isBusy ? '0.7' : '1';
  }

  function showMsg(form, message, type) {
    let msgBox = form.querySelector('.inline-msg');
    if (!msgBox) {
      msgBox = document.createElement('div');
      const buttonGroup = form.querySelector('.btn-group');
      if (buttonGroup) {
        buttonGroup.parentNode.insertBefore(msgBox, buttonGroup);
      } else {
        form.appendChild(msgBox);
      }
    }
    msgBox.textContent = message;
    msgBox.className = `inline-msg ${type}`;
  }
  
</script>

